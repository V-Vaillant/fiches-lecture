<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Index des fiches de lecture</title>
    <style>
        :root {
            --primary-color: #6a1b9a;
            --secondary-color: #9c27b0;
            --accent-color: #e1bee7;
            --background-color: #f8f9fa;
            --text-color: #333;
            --card-bg: #fff;
            --border-radius: 12px;
            --box-shadow: 0 3px 8px rgba(0,0,0,0.15);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.5;
            color: var(--text-color);
            background-color: var(--background-color);
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background-color: var(--primary-color);
            color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .fiches-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }
        
        .fiche-card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .fiche-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .fiche-header {
            padding: 15px;
            background-color: var(--secondary-color);
            color: white;
        }
        
        .fiche-title {
            font-size: 1.3rem;
            margin-bottom: 5px;
        }
        
        .fiche-author {
            font-size: 0.9rem;
            opacity: 0.9;
            font-style: italic;
        }
        
        .fiche-content {
            padding: 15px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .fiche-description {
            margin-bottom: 15px;
            font-size: 0.95rem;
        }
        
        .fiche-link {
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            align-self: flex-start;
            transition: background-color 0.3s ease;
        }
        
        .fiche-link:hover {
            background-color: var(--secondary-color);
        }
        
        .loading {
            text-align: center;
            padding: 30px;
            font-size: 1.2rem;
            color: var(--secondary-color);
        }
        
        .error-message {
            text-align: center;
            padding: 20px;
            background-color: #ffebee;
            color: #c62828;
            border-radius: var(--border-radius);
            margin: 20px 0;
        }
        
        @media (max-width: 768px) {
            .fiches-container {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 20px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .subtitle {
                font-size: 1rem;
            }
        }

        /* Animation de chargement */
        .spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 5px solid rgba(156, 39, 176, 0.3);
            border-radius: 50%;
            border-top-color: var(--secondary-color);
            animation: spin 1s ease-in-out infinite;
            margin: 0 auto 20px auto;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Fiches de Lecture</h1>
            <div class="subtitle">Oeuvres littéraires analysées</div>
        </header>
        
        <div id="fiches-container" class="fiches-container">
            <div class="loading">
                <div class="spinner"></div>
                <p>Chargement des fiches de lecture...</p>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURATION - À PERSONNALISER
        // ===============================
        const CONFIG = {
            // Votre nom d'utilisateur GitHub
            owner: 'V-Vaillant',
            
            // Nom du dépôt GitHub où sont stockées vos fiches
            repo: 'fiches-lecture',
            
            // Branche (généralement 'main' ou 'master')
            branch: 'main',
            
            // Dossier où se trouvent vos fiches (laisser vide '' si à la racine)
            path: '',
            
            // Extensions des fichiers à considérer comme des fiches
            extensions: ['.html'],
            
            // Fichiers à exclure (comme ce fichier index)
            excludeFiles: ['index.html', 'README.html', '404.html'],
            
            // Activer les logs de débogage (true/false)
            debug: true
        };
        
        // CODE PRINCIPAL - NE PAS MODIFIER
        document.addEventListener('DOMContentLoaded', function() {
            const DEBUG = CONFIG.debug;
            
            function debugLog(...args) {
                if (DEBUG) console.log('[Index Fiches]', ...args);
            }
            
            // Extraction des informations d'une fiche HTML
            async function extractBookInfo(htmlContent, filename) {
                debugLog(`Extraction des infos depuis ${filename}`);
                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlContent, 'text/html');
                
                let title = '';
                let author = '';
                let description = 'Fiche de lecture détaillée avec résumé, contexte, personnages et analyse.';
                
                // Tenter d'extraire le titre principal
                const h1Element = doc.querySelector('h1');
                if (h1Element) {
                    title = h1Element.textContent.trim();
                    debugLog(`Titre trouvé: "${title}"`);
                }
                
                // Tenter d'extraire l'auteur depuis la sous-titre
                const subtitleElement = doc.querySelector('.subtitle');
                if (subtitleElement) {
                    const subtitleText = subtitleElement.textContent.trim();
                    debugLog(`Sous-titre trouvé: "${subtitleText}"`);
                    
                    // Extraire l'auteur (généralement au format "de/d' [Auteur] - Fiche de lecture")
                    const authorMatch = subtitleText.match(/d[e']?\s+([\w\s\.\-]+)(\s+-|$)/i);
                    if (authorMatch && authorMatch[1]) {
                        author = authorMatch[1].trim();
                        debugLog(`Auteur extrait: "${author}"`);
                    }
                }
                
                // Tenter d'extraire une brève description du livre
                const resumeSection = doc.querySelector('#resume');
                if (resumeSection) {
                    const highlightBox = resumeSection.querySelector('.highlight-box');
                    if (highlightBox) {
                        description = highlightBox.textContent.trim();
                        debugLog(`Description extraite de highlight-box: "${description.substring(0, 50)}..."`);
                    } else {
                        const firstParagraph = resumeSection.querySelector('p');
                        if (firstParagraph) {
                            description = firstParagraph.textContent.trim();
                            debugLog(`Description extraite du premier paragraphe: "${description.substring(0, 50)}..."`);
                        }
                    }
                }
                
                // Valeurs par défaut si rien n'est trouvé
                if (!title) {
                    title = filename.replace('.html', '')
                        .split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                    debugLog(`Titre par défaut: "${title}"`);
                }
                
                if (!author) {
                    debugLog(`Auteur non trouvé, utilisation de la valeur par défaut`);
                    author = 'Auteur inconnu';
                }
                
                return {
                    title,
                    author,
                    description,
                    filename
                };
            }
            
            // Récupérer la liste des fichiers HTML depuis l'API GitHub
            async function fetchRepositoryFiles() {
                debugLog('Récupération des fichiers depuis l\'API GitHub');
                
                // Vérifier si les paramètres GitHub sont configurés
                if (!CONFIG.owner || !CONFIG.repo) {
                    throw new Error("Configuration GitHub incomplète. Veuillez renseigner votre nom d'utilisateur et le nom du dépôt.");
                }
                
                try {
                    // Construire l'URL de l'API GitHub pour lister les fichiers
                    const apiUrl = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.path}?ref=${CONFIG.branch}`;
                    debugLog(`URL de l'API GitHub: ${apiUrl}`);
                    
                    const response = await fetch(apiUrl);
                    
                    if (!response.ok) {
                        throw new Error(`Erreur API GitHub (${response.status}): ${await response.text()}`);
                    }
                    
                    const files = await response.json();
                    debugLog(`${files.length} fichiers trouvés dans le dépôt`);
                    
                    // Filtrer pour ne garder que les fichiers HTML
                    const htmlFiles = files.filter(file => {
                        // S'assurer que c'est un fichier et pas un dossier
                        if (file.type !== 'file') return false;
                        
                        // Vérifier l'extension
                        const hasValidExtension = CONFIG.extensions.some(ext => 
                            file.name.toLowerCase().endsWith(ext.toLowerCase())
                        );
                        
                        // Vérifier si le fichier est à exclure
                        const isExcluded = CONFIG.excludeFiles.some(excluded => 
                            file.name.toLowerCase() === excluded.toLowerCase()
                        );
                        
                        return hasValidExtension && !isExcluded;
                    });
                    
                    debugLog(`${htmlFiles.length} fichiers HTML valides trouvés`);
                    return htmlFiles;
                    
                } catch (error) {
                    debugLog(`Erreur lors de la récupération depuis GitHub: ${error.message}`);
                    throw error;
                }
            }
            
            // Récupérer le contenu de chaque fichier et extraire les informations
            async function processFiches() {
                try {
                    // Récupérer la liste des fichiers
                    const files = await fetchRepositoryFiles();
                    
                    if (files.length === 0) {
                        debugLog('Aucun fichier HTML valide trouvé dans le dépôt');
                        return [];
                    }
                    
                    // Traiter chaque fichier
                    const fichePromises = files.map(async (file) => {
                        try {
                            debugLog(`Traitement de ${file.name}`);
                            
                            // Utiliser l'URL raw de GitHub pour récupérer le contenu
                            // Format: https://raw.githubusercontent.com/OWNER/REPO/BRANCH/PATH
                            const rawUrl = file.download_url;
                            debugLog(`URL du contenu brut: ${rawUrl}`);
                            
                            const response = await fetch(rawUrl, {
                                method: 'GET',
                                cache: 'no-store',
                                headers: { 'Cache-Control': 'no-cache' }
                            });
                            
                            if (!response.ok) {
                                debugLog(`Erreur lors de la récupération de ${file.name}: ${response.status}`);
                                return null;
                            }
                            
                            const html = await response.text();
                            debugLog(`Contenu de ${file.name} récupéré (${html.length} caractères)`);
                            
                            // Extraire les informations
                            return await extractBookInfo(html, file.name);
                            
                        } catch (error) {
                            debugLog(`Erreur lors du traitement de ${file.name}: ${error.message}`);
                            return null;
                        }
                    });
                    
                    // Attendre que tous les traitements soient terminés
                    const results = await Promise.all(fichePromises);
                    
                    // Filtrer les résultats null (erreurs)
                    const validResults = results.filter(result => result !== null);
                    debugLog(`${validResults.length} fiches valides traitées`);
                    
                    return validResults;
                    
                } catch (error) {
                    debugLog(`Erreur générale: ${error.message}`);
                    throw error;
                }
            }
            
            // Afficher les fiches trouvées
            function displayFiches(fiches) {
                const container = document.getElementById('fiches-container');
                container.innerHTML = ''; // Effacer le message de chargement
                
                if (fiches.length === 0) {
                    container.innerHTML = `
                        <div class="error-message">
                            <h3>Aucune fiche de lecture trouvée</h3>
                            <p>Vérifiez les paramètres de configuration :</p>
                            <ol style="text-align: left; margin: 15px 20px;">
                                <li>Ouvrez ce fichier <code>index.html</code> et vérifiez les paramètres dans l'objet <code>CONFIG</code></li>
                                <li>Assurez-vous que le nom d'utilisateur et le nom du dépôt sont corrects</li>
                                <li>Vérifiez que vous avez bien des fichiers HTML dans votre dépôt</li>
                                <li>Consultez la console (F12) pour plus de détails sur l'erreur</li>
                            </ol>
                        </div>
                    `;
                    return;
                }
                
                // Trier les fiches par ordre alphabétique du titre
                fiches.sort((a, b) => a.title.localeCompare(b.title, 'fr'));
                
                // Créer une carte pour chaque fiche
                fiches.forEach(fiche => {
                    const ficheElement = document.createElement('div');
                    ficheElement.className = 'fiche-card';
                    
                    ficheElement.innerHTML = `
                        <div class="fiche-header">
                            <h2 class="fiche-title">${fiche.title}</h2>
                            <div class="fiche-author">${fiche.author}</div>
                        </div>
                        <div class="fiche-content">
                            <p class="fiche-description">${fiche.description}</p>
                            <a href="${fiche.filename}" class="fiche-link">Consulter la fiche</a>
                        </div>
                    `;
                    
                    container.appendChild(ficheElement);
                });
                
                // Ajouter un message indiquant le nombre de fiches
                const countElement = document.createElement('div');
                countElement.style.textAlign = 'center';
                countElement.style.margin = '20px 0';
                countElement.style.color = '#666';
                countElement.innerHTML = `<p>${fiches.length} fiche${fiches.length > 1 ? 's' : ''} de lecture disponible${fiches.length > 1 ? 's' : ''}</p>`;
                container.appendChild(countElement);
                
                debugLog(`${fiches.length} fiches affichées`);
            }
            
            // Initialisation de la page
            async function init() {
                try {
                    debugLog('Initialisation de la page d\'index');
                    
                    // Détecter si l'index est ouvert directement en local (file://)
                    if (window.location.protocol === 'file:') {
                        throw new Error("L'utilisation locale avec le protocole file:// n'est pas prise en charge. Veuillez utiliser un serveur web ou GitHub Pages.");
                    }
                    
                    // Détecter automatiquement les configurations GitHub Pages
                    if (!CONFIG.owner || !CONFIG.repo) {
                        // Tenter de déduire le propriétaire et le dépôt à partir de l'URL
                        const githubPagesPattern = /https?:\/\/([^.]+)\.github\.io\/([^\/]+)/;
                        const match = window.location.href.match(githubPagesPattern);
                        
                        if (match) {
                            CONFIG.owner = match[1];
                            CONFIG.repo = match[2];
                            debugLog(`Configuration GitHub Pages détectée automatiquement: ${CONFIG.owner}/${CONFIG.repo}`);
                        }
                    }
                    
                    const fiches = await processFiches();
                    displayFiches(fiches);
                    
                } catch (error) {
                    debugLog(`Erreur d'initialisation: ${error.message}`);
                    const container = document.getElementById('fiches-container');
                    container.innerHTML = `
                        <div class="error-message">
                            <h3>Erreur lors du chargement des fiches</h3>
                            <p>${error.message}</p>
                            <div style="margin-top: 15px; text-align: left;">
                                <p><strong>Solutions possibles :</strong></p>
                                <ul style="padding-left: 20px; margin-top: 10px;">
                                    <li>Vérifiez que votre dépôt est <strong>public</strong> (l'API GitHub ne fonctionne qu'avec des dépôts publics sans authentification)</li>
                                    <li>Vérifiez les paramètres de configuration du dépôt dans l'objet <code>CONFIG</code></li>
                                    <li>Assurez-vous que GitHub Pages est correctement configuré</li>
                                    <li>Consultez la console développeur (F12) pour voir les messages d'erreur détaillés</li>
                                </ul>
                            </div>
                        </div>
                    `;
                }
            }
            
            // Démarrer après un court délai
            setTimeout(init, 300);
        });
    </script>
</body>
</html>
