<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Index des fiches de lecture</title>
    <style>
        :root {
            --primary-color: #6a1b9a;
            --secondary-color: #9c27b0;
            --accent-color: #e1bee7;
            --background-color: #f8f9fa;
            --text-color: #333;
            --card-bg: #fff;
            --border-radius: 12px;
            --box-shadow: 0 3px 8px rgba(0,0,0,0.15);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.5;
            color: var(--text-color);
            background-color: var(--background-color);
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background-color: var(--primary-color);
            color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .fiches-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }
        
        .fiche-card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .fiche-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .fiche-header {
            padding: 15px;
            background-color: var(--secondary-color);
            color: white;
        }
        
        .fiche-title {
            font-size: 1.3rem;
            margin-bottom: 5px;
        }
        
        .fiche-author {
            font-size: 0.9rem;
            opacity: 0.9;
            font-style: italic;
        }
        
        .fiche-content {
            padding: 15px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .fiche-description {
            margin-bottom: 15px;
            font-size: 0.95rem;
        }
        
        .fiche-link {
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            align-self: flex-start;
            transition: background-color 0.3s ease;
        }
        
        .fiche-link:hover {
            background-color: var(--secondary-color);
        }
        
        .loading {
            text-align: center;
            padding: 30px;
            font-size: 1.2rem;
            color: var(--secondary-color);
        }
        
        .error-message {
            text-align: center;
            padding: 20px;
            background-color: #ffebee;
            color: #c62828;
            border-radius: var(--border-radius);
            margin: 20px 0;
        }
        
        @media (max-width: 768px) {
            .fiches-container {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 20px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .subtitle {
                font-size: 1rem;
            }
        }

        /* Animation de chargement */
        .spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 5px solid rgba(156, 39, 176, 0.3);
            border-radius: 50%;
            border-top-color: var(--secondary-color);
            animation: spin 1s ease-in-out infinite;
            margin: 0 auto 20px auto;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Fiches de Lecture</h1>
            <div class="subtitle">Oeuvres littéraires analysées</div>
        </header>
        
        <div id="fiches-container" class="fiches-container">
            <div class="loading">
                <div class="spinner"></div>
                <p>Chargement des fiches de lecture...</p>
            </div>
        </div>
    </div>

    <script>
        // Configuration des fiches de lecture
        // ===================================
        // Vous pouvez soit:
        // 1. Laisser cette liste vide pour une détection automatique des fichiers (fonctionne sur la plupart des serveurs)
        // 2. Ajouter manuellement les noms de vos fichiers HTML pour une détection garantie
        const FICHES_DE_LECTURE = [
            'femme-gelee.html',  // Exemple: La femme gelée
            'cannibale.html',    // Exemple: Cannibale
            // Ajoutez d'autres fiches ici au format 'nom-fichier.html',
        ];
        
        // Code principal - ne pas modifier sauf si vous savez ce que vous faites
        document.addEventListener('DOMContentLoaded', function() {
            const DEBUG = true; // Mettre à true pour voir les messages de débogage dans la console
            
            function debugLog(...args) {
                if (DEBUG) {
                    console.log('[Index Fiches]', ...args);
                }
            }
            
            // Fonction pour extraire le titre et l'auteur d'une fiche de lecture HTML
            async function extractBookInfo(htmlContent, filename) {
                debugLog(`Extraction des infos depuis ${filename}`);
                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlContent, 'text/html');
                
                let title = '';
                let author = '';
                let description = 'Fiche de lecture détaillée avec résumé, contexte, personnages et analyse.';
                
                // Tenter d'extraire le titre principal
                const h1Element = doc.querySelector('h1');
                if (h1Element) {
                    title = h1Element.textContent.trim();
                    debugLog(`Titre trouvé: "${title}"`);
                }
                
                // Tenter d'extraire l'auteur depuis la sous-titre
                const subtitleElement = doc.querySelector('.subtitle');
                if (subtitleElement) {
                    const subtitleText = subtitleElement.textContent.trim();
                    debugLog(`Sous-titre trouvé: "${subtitleText}"`);
                    
                    // Extraire l'auteur (généralement au format "de/d' [Auteur] - Fiche de lecture")
                    const authorMatch = subtitleText.match(/d[e']?\s+([\w\s\.\-]+)(\s+-|$)/i);
                    if (authorMatch && authorMatch[1]) {
                        author = authorMatch[1].trim();
                        debugLog(`Auteur extrait: "${author}"`);
                    }
                }
                
                // Tenter d'extraire une brève description du livre
                const resumeSection = doc.querySelector('#resume');
                if (resumeSection) {
                    const highlightBox = resumeSection.querySelector('.highlight-box');
                    if (highlightBox) {
                        description = highlightBox.textContent.trim();
                        debugLog(`Description extraite de highlight-box: "${description.substring(0, 50)}..."`);
                    } else {
                        const firstParagraph = resumeSection.querySelector('p');
                        if (firstParagraph) {
                            description = firstParagraph.textContent.trim();
                            debugLog(`Description extraite du premier paragraphe: "${description.substring(0, 50)}..."`);
                        }
                    }
                }
                
                // Valeurs par défaut si rien n'est trouvé
                if (!title) {
                    title = filename.replace('.html', '')
                        .split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                    debugLog(`Titre par défaut: "${title}"`);
                }
                
                if (!author) {
                    debugLog(`Auteur non trouvé, utilisation de la valeur par défaut`);
                    author = 'Auteur inconnu';
                }
                
                return {
                    title,
                    author,
                    description,
                    filename
                };
            }
            
            // Fonction pour récupérer et scanner les fichiers HTML du répertoire
            async function scanHtmlFiles() {
                // 1. Si la liste manuelle est remplie, l'utiliser directement
                if (FICHES_DE_LECTURE.length > 0) {
                    debugLog(`Utilisation de la liste manuelle de ${FICHES_DE_LECTURE.length} fiches`);
                    return processFileList(FICHES_DE_LECTURE);
                }
                
                // 2. Sinon, tenter la détection automatique
                debugLog(`Tentative de détection automatique des fichiers HTML`);
                try {
                    // Récupérer la liste des fichiers dans le répertoire actuel
                    const response = await fetch('.');
                    const html = await response.text();
                    debugLog(`Contenu du répertoire récupéré (${html.length} caractères)`);
                    
                    // Rechercher tous les liens vers des fichiers HTML
                    const htmlFileRegex = /href="([^"]+\.html)"/g;
                    let match;
                    const htmlFiles = [];
                    
                    while ((match = htmlFileRegex.exec(html)) !== null) {
                        const filename = match[1];
                        if (filename !== 'index.html' && !filename.includes('/') && 
                            !filename.startsWith('?') && !filename.startsWith('#')) {
                            htmlFiles.push(filename);
                            debugLog(`Fichier HTML trouvé: ${filename}`);
                        }
                    }
                    
                    if (htmlFiles.length > 0) {
                        debugLog(`${htmlFiles.length} fichiers HTML trouvés automatiquement`);
                        return processFileList(htmlFiles);
                    }
                    
                    // Si aucun fichier trouvé, essayer une autre méthode
                    debugLog(`Aucun fichier trouvé avec la méthode regex. Tentative avec DOM`);
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    let links = Array.from(doc.querySelectorAll('a[href]'))
                        .filter(link => {
                            const href = link.getAttribute('href');
                            return href.endsWith('.html') && 
                                  href !== 'index.html' && 
                                  !href.includes('/') && 
                                  !href.startsWith('?') &&
                                  !href.startsWith('#');
                        })
                        .map(link => link.getAttribute('href'));
                    
                    if (links.length > 0) {
                        debugLog(`${links.length} fichiers HTML trouvés avec la méthode DOM`);
                        return processFileList(links);
                    }
                    
                    // Si toujours rien, utiliser une liste de noms courants pour tester
                    debugLog(`Aucun fichier trouvé. Tentative avec des noms courants`);
                    const commonNames = [
                        'femme-gelee.html', 'la-femme-gelee.html', 
                        'cannibale.html', 
                        'etranger.html', 'l-etranger.html',
                        'candide.html', 
                        'germinal.html',
                        'peste.html', 'la-peste.html',
                        'madame-bovary.html'
                    ];
                    
                    return processFileList(commonNames);
                    
                } catch (error) {
                    debugLog(`Erreur lors de la détection automatique: ${error.message}`);
                    throw new Error(`Impossible de détecter automatiquement les fiches. ${error.message}`);
                }
            }
            
            // Traiter une liste de noms de fichiers et récupérer leurs infos
            async function processFileList(fileList) {
                debugLog(`Traitement de ${fileList.length} fichiers`);
                
                // Tester chaque fichier pour voir s'il existe et extraire ses informations
                const fichePromises = fileList.map(async (filename) => {
                    try {
                        debugLog(`Tentative de récupération de ${filename}`);
                        const response = await fetch(filename, { method: 'GET' });
                        
                        if (!response.ok) {
                            debugLog(`Fichier ${filename} introuvable (${response.status})`);
                            return null;
                        }
                        
                        const html = await response.text();
                        debugLog(`Fichier ${filename} récupéré (${html.length} caractères)`);
                        
                        // Extraire les informations du livre
                        return await extractBookInfo(html, filename);
                    } catch (error) {
                        debugLog(`Erreur lors du traitement de ${filename}: ${error.message}`);
                        return null;
                    }
                });
                
                // Attendre toutes les promesses et filtrer les résultats nuls
                const results = await Promise.all(fichePromises);
                const validResults = results.filter(result => result !== null);
                
                debugLog(`${validResults.length} fiches valides trouvées sur ${fileList.length} testées`);
                return validResults;
            }
            
            // Fonction pour afficher les fiches de lecture
            function displayFiches(fiches) {
                const container = document.getElementById('fiches-container');
                container.innerHTML = ''; // Effacer le message de chargement
                
                if (fiches.length === 0) {
                    debugLog(`Aucune fiche à afficher`);
                    container.innerHTML = `
                        <div class="error-message">
                            <h3>Aucune fiche de lecture trouvée</h3>
                            <p>Vous pouvez ajouter vos fiches de lecture en suivant ces étapes :</p>
                            <ol style="text-align: left; margin: 15px 20px;">
                                <li>Placez vos fichiers HTML de fiches de lecture dans ce même dossier</li>
                                <li>Si la détection automatique ne fonctionne pas, ouvrez ce fichier et ajoutez manuellement les noms des fichiers dans la variable <code>FICHES_DE_LECTURE</code> au début du script</li>
                                <li>Assurez-vous que les fiches HTML ont la même structure avec un titre H1, une classe .subtitle et une section #resume</li>
                            </ol>
                        </div>
                    `;
                    return;
                }
                
                // Trier les fiches par ordre alphabétique du titre
                fiches.sort((a, b) => a.title.localeCompare(b.title, 'fr'));
                
                // Créer une carte pour chaque fiche
                fiches.forEach(fiche => {
                    const ficheElement = document.createElement('div');
                    ficheElement.className = 'fiche-card';
                    
                    ficheElement.innerHTML = `
                        <div class="fiche-header">
                            <h2 class="fiche-title">${fiche.title}</h2>
                            <div class="fiche-author">${fiche.author}</div>
                        </div>
                        <div class="fiche-content">
                            <p class="fiche-description">${fiche.description}</p>
                            <a href="${fiche.filename}" class="fiche-link">Consulter la fiche</a>
                        </div>
                    `;
                    
                    container.appendChild(ficheElement);
                });
                
                debugLog(`${fiches.length} fiches affichées`);
            }
            
            // Fonction principale pour initialiser la page
            async function init() {
                try {
                    debugLog('Initialisation de la page d\'index');
                    const fiches = await scanHtmlFiles();
                    displayFiches(fiches);
                } catch (error) {
                    debugLog(`Erreur d'initialisation: ${error.message}`);
                    const container = document.getElementById('fiches-container');
                    container.innerHTML = `
                        <div class="error-message">
                            <h3>Erreur lors du chargement des fiches</h3>
                            <p>Impossible de récupérer la liste des fiches de lecture : ${error.message}</p>
                            <div style="margin-top: 15px; text-align: left;">
                                <p><strong>Solutions possibles :</strong></p>
                                <ul style="padding-left: 20px; margin-top: 10px;">
                                    <li>Si vous exécutez ce fichier localement, ouvrez-le via un serveur web</li>
                                    <li>Ajoutez manuellement les noms de fichiers dans la variable <code>FICHES_DE_LECTURE</code> au début du script</li>
                                    <li>Vérifiez les permissions d'accès aux fichiers sur votre serveur</li>
                                    <li>Ouvrez la console de développement (F12) pour voir les messages d'erreur détaillés</li>
                                </ul>
                            </div>
                        </div>
                    `;
                }
            }
            
            // Lancer l'initialisation avec un délai pour permettre à la page de s'afficher
            setTimeout(init, 500);
        });
    </script>
</body>
</html>
